<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title }}</title>
    <link rel="stylesheet" type="text/css" href="polar.css" />
    <link rel="stylesheet" type="text/css" href="main.css" />
  </head>
  <body>
    <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none">
        <symbol id="home" viewBox="0 0 32 32">
            <polyline points="6,30 6,14 2,18 16,4 24,12 24,4 24,12 30,18 26,14 26,30 4,30" style="fill:none;stroke-width:4"/>
        </symbol>
    </svg>
    <div id="page">
        <header>
            <div style="height:0; width:0; margin-top:-3.8rem; margin-bottom:1rem;">
                <p style="font-size:2.6rem; color:rgba(127,127,127,0.15)">LiberCantorum</p>
            </div>
            <p id="nav" class="no-print" style="width:100%; background-color:080; text-align:right; margin-top:2em; margin-bottom:-3em;">
                <a href="index.html">&nbsp;
                    <svg width="1em" height="1em" stroke="currentColor">
                        <use xlink:href="#home" />
                    </svg>
                </svg>&nbsp;</a>
            </p>
            <h1>{{ title }}</h1>
        </header>
        <main>
            {% if score is defined %}
            <script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.4.0"></script>
            <img class="svg" src="{{ score }}" alt="{{ title }} - score" style="width:28rem;"><br>
            {% endif %}
            {% if file is defined %}
            <div class="midi-controls no-print" style="margin-bottom: 10px;">
                <label for="tempo-slider">Tempo: </label>
                <input type="range" id="tempo-slider" min="50" max="200" value="100" step="5" style="width: 200px;">
                <span id="tempo-value">100%</span>
            </div>
            <midi-player id="midi-player" src="{{ file }}.midi" sound-font visualizer="#myStaffVisualizer">
            </midi-player>
            <midi-visualizer type="staff" id="myStaffVisualizer" src="{{ file }}.midi" style="background-color:#fff">
            </midi-visualizer>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const tempoSlider = document.getElementById('tempo-slider');
                    const tempoValue = document.getElementById('tempo-value');
                    const midiPlayer = document.getElementById('midi-player');
                    let originalTempo = 120; // Default BPM
                    let player = null;
                    let isPlayerReady = false;

                    // Update tempo display
                    tempoSlider.addEventListener('input', function() {
                        tempoValue.textContent = this.value + '%';
                    });

                    // Try multiple approaches to access the internal player
                    function findPlayer() {
                        // Approach 1: Direct property access
                        if (midiPlayer.player) {
                            return midiPlayer.player;
                        }

                        // Approach 2: Private property access
                        if (midiPlayer._player) {
                            return midiPlayer._player;
                        }

                        return null;
                    }

                    // Extract tempo from note sequence
                    function extractOriginalTempo() {
                        try {
                            if (midiPlayer.noteSequence) {
                                const seq = midiPlayer.noteSequence;
                                if (seq.tempos && seq.tempos.length > 0) {
                                    originalTempo = seq.tempos[0].qpm || 120;
                                    console.log('Extracted original tempo from noteSequence:', originalTempo);
                                    return;
                                }
                            }

                            // Fallback: try to get from player if available
                            if (player && player.getPlayState) {
                                const playState = player.getPlayState();
                                if (playState && playState.noteSequence && playState.noteSequence.tempos) {
                                    const tempos = playState.noteSequence.tempos;
                                    if (tempos.length > 0) {
                                        originalTempo = tempos[0].qpm || 120;
                                        console.log('Extracted original tempo from player:', originalTempo);
                                        return;
                                    }
                                }
                            }

                            console.log('Using default tempo:', originalTempo);
                        } catch (error) {
                            console.warn('Error extracting tempo, using default:', error);
                        }
                    }

                    // Wait for the MIDI player to load
                    function waitForPlayerLoad() {
                        const checkPlayer = () => {
                            player = findPlayer();
                            if (player) {
                                console.log('MIDI Player found');
                                extractOriginalTempo();
                                isPlayerReady = true;

                                // Update slider color to indicate it's ready
                                tempoSlider.style.accentColor = '#4CAF50';
                                return true;
                            }
                            return false;
                        };

                        // Try immediately
                        if (checkPlayer()) return;

                        // Then try periodically
                        let attempts = 0;
                        const interval = setInterval(() => {
                            attempts++;
                            if (checkPlayer()) {
                                clearInterval(interval);
                            } else if (attempts > 100) { // Give up after 10 seconds
                                clearInterval(interval);
                                console.warn('Could not find MIDI player - tempo control may not work');
                                tempoSlider.style.accentColor = '#f44336'; // Red to indicate error
                                tempoSlider.title = 'Tempo control not available';
                            }
                        }, 100);
                    }

                    // Handle tempo changes
                    tempoSlider.addEventListener('change', function() {
                        if (!player || !isPlayerReady) {
                            console.warn('MIDI player not ready for tempo control');
                            return;
                        }

                        const tempoMultiplier = parseFloat(this.value) / 100;
                        const newTempo = originalTempo * tempoMultiplier;

                        console.log(`Setting tempo to ${Math.round(newTempo)} BPM (${this.value}% of ${Math.round(originalTempo)} BPM)`);

                        try {
                            if (typeof player.setTempo === 'function') {
                                player.setTempo(newTempo);

                                // Visual feedback
                                tempoValue.style.color = '#4CAF50';
                                setTimeout(() => {
                                    tempoValue.style.color = '';
                                }, 500);
                            } else {
                                console.warn('setTempo method not available on player');
                                tempoValue.style.color = '#f44336';
                                setTimeout(() => {
                                    tempoValue.style.color = '';
                                }, 1000);
                            }
                        } catch (error) {
                            console.error('Error setting tempo:', error);
                            tempoValue.style.color = '#f44336';
                            setTimeout(() => {
                                tempoValue.style.color = '';
                            }, 1000);
                        }
                    });

                    // Start looking for the player
                    waitForPlayerLoad();

                    // Also try when the midi-player fires events
                    midiPlayer.addEventListener('load', () => {
                        console.log('MIDI player loaded event');
                        setTimeout(waitForPlayerLoad, 100);
                    });

                    // Listen for when the player actually starts to get tempo info
                    midiPlayer.addEventListener('start', () => {
                        console.log('MIDI player started');
                        if (!isPlayerReady) {
                            setTimeout(waitForPlayerLoad, 100);
                        }
                    });
                });
            </script>
            {% endif %}
            <p class="lyrics">{{ lyrics|safe }}</p>

        </main>

    </div>
    <footer>
        <p id="copyright" class="no-print" style="width:100%; background-color:080; text-align:right; font-size:0.6rem;">
            LiberCantorum v0.8.1dev (c) 2025 by Dirk Winkel, licensed under GPLv3 or newer
        </p>
    </footer>
  </body>
</html>
